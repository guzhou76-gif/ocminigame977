<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>槿天华桌宠模拟器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --c-bg-deep: #3D3E49;
      --c-bg-soft: #4a4b57;
      --c-accent: #65272A;
      --c-text-main: #C6C1C2;
      --c-text-sub: #9B9EA6;
      --c-border: #9B9EA6;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 16px 40px rgba(0,0,0,0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #3D3E49 0, #1e1f26 50%, #111117 100%);
      color: var(--c-text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-shell {
      width: 100%;
      max-width: 820px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .game-card {
      width: 100%;
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, #3D3E49, #2a2b33);
      border: 1px solid rgba(155,158,166,0.4);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* 顶部栏 */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(198,193,194,0.3);
      background: rgba(61,62,73,0.9);
    }

    .top-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .top-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .top-sub {
      font-size: 11px;
      color: var(--c-text-sub);
    }

    .top-pills {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(198,193,194,0.4);
      padding: 2px 10px;
      font-size: 10px;
      color: var(--c-text-sub);
      background: rgba(33,34,42,0.7);
    }

    .pill-accent {
      border-color: rgba(101,39,42,0.9);
      color: #f0d9da;
      background: rgba(101,39,42,0.9);
    }

    /* 主体布局：上半桌面，下半控制 */
    .main-layout {
      display: grid;
      grid-template-rows: minmax(210px, 45vh) minmax(210px, 55vh);
    }

    @media (min-width: 900px) {
      .main-layout {
        grid-template-columns: minmax(340px, 1.2fr) minmax(320px, 1fr);
        grid-template-rows: auto;
      }
      .desk-area-wrapper {
        border-right: 1px solid rgba(198,193,194,0.35);
      }
    }

    /* 桌面区域 */
    .desk-area-wrapper {
      position: relative;
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(198,193,194,0.35);
    }

    .desk-area {
      position: relative;
      border-radius: var(--radius-md);
      overflow: visible;
      background: #2a2b33;
      height: 100%;
      min-height: 260px;
    }

    .desk-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.8;
      transform: scale(1.02);
      border-radius: var(--radius-md);
    }

    .desk-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.35), rgba(0,0,0,0.1));
      border-radius: var(--radius-md);
    }

    .desk-foreground {
      position: relative;
      height: 100%;
      padding: 18px 16px 24px;
    }

    .desk-office-badge {
      position: absolute;
      top: 18px;
      left: 18px;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(17, 18, 25, 0.65);
      border: 1px solid rgba(198,193,194,0.35);
      color: #f5e9ea;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: inline-flex;
      flex-direction: column;
      gap: 2px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      pointer-events: none;
    }

    .desk-office-badge .badge-value {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .desk-office-badge .badge-label {
      font-size: 10px;
      color: rgba(245, 233, 234, 0.8);
      letter-spacing: 0.2em;
    }

    .desk-office-badge.is-busy {
      background: rgba(101,39,42,0.75);
      border-color: rgba(247,213,218,0.6);
    }

    .sprite-lane {
      position: relative;
      height: 100%;
      padding-bottom: 110px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .sprite-hit-area {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .sprite {
      position: absolute;
      bottom: 0;
      width: clamp(180px, 34vw, 320px);
      aspect-ratio: auto;
      border-radius: 0;
      overflow: visible;
      border: none;
      background: transparent;
      cursor: pointer;
      animation: walk 12s ease-in-out infinite alternate;
      box-shadow: none;
      transform-origin: center bottom;
      transition: transform 0.15s ease-out, box-shadow 0.15s;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,0.55));
    }

    .sprite img {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
    }

    .sprite:active {
      transform: scale(0.97) translateY(2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }

    @keyframes walk {
      0%   { left: 8%; }
      50%  { left: 55%; }
      100% { left: 26%; }
    }

    .desk-status-row {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(18,18,24,0.65);
      border: 1px solid rgba(198,193,194,0.35);
      backdrop-filter: blur(8px);
    }

    .status-group {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 80px;
    }

    .status-label {
      color: var(--c-text-sub);
      font-size: 10px;
    }

    .status-bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(24,25,33,0.9);
      overflow: hidden;
      position: relative;
    }

    .status-bar-fill {
      position: absolute;
      inset: 0;
      width: 60%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--c-accent), #C6C1C2);
      transition: width 0.2s ease-out;
    }

    .status-value {
      font-size: 11px;
      color: var(--c-text-main);
    }

    .desk-time-tag {
      font-size: 10px;
      color: var(--c-text-sub);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(198,193,194,0.4);
      background: rgba(24,25,33,0.9);
      white-space: nowrap;
    }

    /* 对话框 */
    .dialog-wrapper {
      padding: 6px 12px 10px;
    }

    .dialog-box {
      border-radius: var(--radius-md);
      border: 1px solid rgba(198,193,194,0.45);
      background: linear-gradient(135deg, rgba(61,62,73,0.95), rgba(33,34,42,0.95));
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 70px;
    }

    .dialog-name {
      font-size: 11px;
      color: var(--c-text-sub);
    }

    .dialog-text {
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 控制区域：标签页 + 面板 */
    .control-area {
      padding: 6px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tabs-row {
      display: flex;
      gap: 6px;
      font-size: 12px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      padding: 6px 8px;
      border: none;
      cursor: pointer;
      background: rgba(33,34,42,0.9);
      color: var(--c-text-sub);
      border: 1px solid transparent;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .tab-btn.active {
      background: rgba(101,39,42,0.95);
      border-color: rgba(198,193,194,0.7);
      color: #f5e9ea;
    }

    .panels {
      position: relative;
      flex: 1;
      min-height: 170px;
    }

    .panel {
      border-radius: var(--radius-md);
      border: 1px solid rgba(198,193,194,0.35);
      background: rgba(33,34,42,0.96);
      padding: 8px;
      font-size: 12px;
      display: none;
      height: 100%;
    }

    .panel.active {
      display: block;
    }

    /* 桌面面板：基础互动按钮 */
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .action-card {
      border-radius: 10px;
      border: 1px solid rgba(198,193,194,0.4);
      background: rgba(37,38,47,0.95);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
    }

    .action-card:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
      border-color: rgba(198,193,194,0.9);
    }

    .action-title {
      font-size: 12px;
      font-weight: 500;
    }

    .action-sub {
      font-size: 11px;
      color: var(--c-text-sub);
    }

    .small-log {
      margin-top: 4px;
      font-size: 11px;
      color: var(--c-text-sub);
      max-height: 60px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* 任务面板：简单小游戏 */
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--c-text-sub);
    }

    .task-label {
      font-size: 11px;
      color: var(--c-text-main);
    }

    .task-count {
      font-weight: 500;
      color: var(--c-text-main);
    }

    .task-buttons {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .task-btn {
      border-radius: 10px;
      border: 1px solid rgba(198,193,194,0.4);
      background: rgba(37,38,47,0.95);
      padding: 6px;
      font-size: 11px;
      cursor: pointer;
      text-align: left;
    }

    .task-log {
      font-size: 11px;
      color: var(--c-text-sub);
      max-height: 80px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* 消息面板：模拟手机聊天 UI */
    .chat-shell {
      display: flex;
      flex-direction: column;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #2c2d35;
    }

    .chat-top {
      padding: 6px 8px;
      background: #3D3E49;
      border-bottom: 1px solid rgba(198,193,194,0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }

    .chat-name {
      font-weight: 500;
    }

    .chat-tag {
      font-size: 10px;
      color: var(--c-text-sub);
    }

    .chat-body {
      flex: 1;
      padding: 6px 6px 0;
      overflow-y: auto;
      background: #2f3039;
    }

    .chat-row {
      display: flex;
      margin-bottom: 4px;
    }

    .chat-row.you {
      justify-content: flex-end;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 5px 8px;
      border-radius: 12px;
      font-size: 11px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .chat-row.oc .chat-bubble {
      border-bottom-left-radius: 3px;
      background: #3D3E49;
      color: var(--c-text-main);
    }

    .chat-row.you .chat-bubble {
      border-bottom-right-radius: 3px;
      background: #65272A;
      color: #f5e9ea;
    }

    .chat-input-bar {
      padding: 4px 6px;
      border-top: 1px solid rgba(198,193,194,0.25);
      background: #3D3E49;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .chat-preset {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(198,193,194,0.4);
      background: #2a2b33;
      color: var(--c-text-sub);
      font-size: 11px;
      padding: 4px 8px;
    }

    .chat-send-btn {
      border-radius: 999px;
      border: none;
      background: #65272A;
      color: #f5e9ea;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* 底部文案 */
    .bottom-note {
      padding: 4px 14px 10px;
      font-size: 10px;
      color: var(--c-text-sub);
      text-align: right;
    }

    /* 滚动条细节 */
    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(155,158,166,0.6);
      border-radius: 999px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="game-card">
    <!-- 顶部栏 -->
    <div class="top-bar">
      <div class="top-info">
        <div class="top-title">槿天华桌宠模拟器</div>
        <div class="top-sub" id="topSub">桌面已联动，等待你的指派。</div>
      </div>
      <div class="top-pills">
        <div class="pill">本地存档</div>
        <div class="pill pill-accent" id="modeTag">桌面在线</div>
      </div>
    </div>

    <div class="main-layout">
      <!-- 左 / 上：桌面 + 对话 -->
      <div>
        <!-- 桌面区域 -->
        <div class="desk-area-wrapper">
          <div class="desk-area">
            <div class="desk-bg" id="deskBg"
                 style="background-image:url('images/bg_desk_day.jpg');"></div>
            <div class="desk-overlay"></div>
            <div class="desk-foreground">
                <div class="desk-office-badge" id="officeBadge">
                  <div class="badge-label">Office 状态</div>
                  <div class="badge-value" id="officeStateText">日间 · 桌宠值守</div>
                </div>
              <div class="sprite-lane">
                <div class="sprite-hit-area">
                  <div class="sprite" id="sprite">
                    <img id="spriteImg" src="images/jth_stand.png" alt="槿天华">
                  </div>
                </div>
              </div>
              <div class="desk-status-row">
                <div class="status-group">
                  <div class="status-item">
                    <div class="status-label">心情</div>
                    <div class="status-bar">
                      <div class="status-bar-fill" id="moodBar"></div>
                    </div>
                    <div class="status-value" id="moodText"></div>
                  </div>
                  <div class="status-item">
                    <div class="status-label">压力</div>
                    <div class="status-bar">
                      <div class="status-bar-fill" id="stressBar"></div>
                    </div>
                    <div class="status-value" id="stressText"></div>
                  </div>
                  <div class="status-item">
                    <div class="status-label">未处理事务</div>
                    <div class="status-bar">
                      <div class="status-bar-fill" id="workloadBar"></div>
                    </div>
                    <div class="status-value" id="workloadText"></div>
                  </div>
                </div>
                <div class="desk-time-tag" id="timeTag">日间模式</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 对话框 -->
        <div class="dialog-wrapper">
          <div class="dialog-box">
            <div class="dialog-name" id="dialogName">槿天华</div>
            <div class="dialog-text" id="dialogText">
……刚刚被塞进这个屏幕里的是我。暂时借用一下你的桌面，麻烦多关照。
            </div>
          </div>
        </div>
      </div>

      <!-- 右 / 下：控制区 -->
      <div class="control-area">
        <!-- 标签页 -->
        <div class="tabs-row">
          <button class="tab-btn active" data-tab="desk">桌面</button>
          <button class="tab-btn" data-tab="task">任务</button>
          <button class="tab-btn" data-tab="chat">消息</button>
        </div>

        <!-- 面板内容 -->
        <div class="panels">
          <!-- 桌面互动 -->
          <div class="panel active" id="panel-desk">
            <div class="actions-grid">
              <div class="action-card" data-action="pet">
                <div class="action-title">摸头 / 点他</div>
                <div class="action-sub">确认屏幕里的人不是幻觉。</div>
              </div>
              <div class="action-card" data-action="snack">
                <div class="action-title">投喂零食</div>
                <div class="action-sub">据说加班桌宠靠糖分存活。</div>
              </div>
              <div class="action-card" data-action="remindWork">
                <div class="action-title">提醒工作</div>
                <div class="action-sub">“你不是还有待办没写吗？”</div>
              </div>
              <div class="action-card" data-action="toggleDay">
                <div class="action-title">切换昼夜</div>
                <div class="action-sub">看一眼他加班 / 下班的样子。</div>
              </div>
            </div>
            <div class="small-log" id="deskLog"></div>
          </div>

          <!-- 任务小游戏 -->
          <div class="panel" id="panel-task">
            <div class="task-header">
              <div class="task-label">未处理事务：<span class="task-count" id="taskCount">0</span></div>
              <div class="task-label">今日模式：<span id="taskMode">正常工作日</span></div>
            </div>
            <div class="task-buttons">
              <button class="task-btn" data-task="spawn">
                生成新任务<br>
                <span style="color:var(--c-text-sub);">随机来一封邮件 / 一份报表 / 一个电话。</span>
              </button>
              <button class="task-btn" data-task="processOne">
                处理一项<br>
                <span style="color:var(--c-text-sub);">认真处理一条，压力略有波动。</span>
              </button>
              <button class="task-btn" data-task="processBatch">
                集中清理<br>
                <span style="color:var(--c-text-sub);">开“清单模式”，一次解决一堆。</span>
              </button>
              <button class="task-btn" data-task="ignore">
                假装没看到<br>
                <span style="color:var(--c-text-sub);">“先放着吧。”——危险发言。</span>
              </button>
            </div>
            <div class="task-log" id="taskLog"></div>
          </div>

          <!-- 消息：模拟聊天 -->
          <div class="panel" id="panel-chat">
            <div class="chat-shell">
              <div class="chat-top">
                <div>
                  <div class="chat-name">槿天华</div>
                  <div class="chat-tag" id="chatStatus">状态：桌宠在线</div>
                </div>
                <div class="pill" style="padding:2px 8px;">伪·聊天界面</div>
              </div>
              <div class="chat-body" id="chatBody">
                <!-- 初始几条消息 -->
              </div>
              <div class="chat-input-bar">
                <select class="chat-preset" id="chatPreset">
                  <option value="忙吗">现在忙吗？</option>
                  <option value="加班">你今天会加班到几点？</option>
                  <option value="摸鱼">允许摸鱼五分钟吗？</option>
                  <option value="鼓励">好累的话可以休息一下。</option>
                </select>
                <button class="chat-send-btn" id="chatSendBtn">发送</button>
              </div>
            </div>
          </div>
        </div>

        <div class="bottom-note">
          数据存储于本地浏览器，不会上传到服务器。
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // —— 游戏状态（本地存档） ——
  const DEFAULT_STATE = {
    mood: 70,
    stress: 40,
    workload: 20,
    dayMode: "day",
    deskLog: "",
    taskLog: "",
    tasks: 3,
    chatHistory: []
  };

  let state = loadState();

  // —— DOM 引用 ——
  const moodBar = document.getElementById("moodBar");
  const moodText = document.getElementById("moodText");
  const stressBar = document.getElementById("stressBar");
  const stressText = document.getElementById("stressText");
  const workloadBar = document.getElementById("workloadBar");
  const workloadText = document.getElementById("workloadText");
  const timeTag = document.getElementById("timeTag");
  const modeTag = document.getElementById("modeTag");
  const topSub = document.getElementById("topSub");
  const deskBg = document.getElementById("deskBg");
  const sprite = document.getElementById("sprite");
  const spriteImg = document.getElementById("spriteImg");
  const officeBadge = document.getElementById("officeBadge");
  const officeStateText = document.getElementById("officeStateText");

  const dialogName = document.getElementById("dialogName");
  const dialogText = document.getElementById("dialogText");

  const deskLog = document.getElementById("deskLog");
  const taskLog = document.getElementById("taskLog");
  const taskCount = document.getElementById("taskCount");
  const taskMode = document.getElementById("taskMode");

  const tabBtns = document.querySelectorAll(".tab-btn");
  const panels = {
    desk: document.getElementById("panel-desk"),
    task: document.getElementById("panel-task"),
    chat: document.getElementById("panel-chat")
  };

  const chatBody = document.getElementById("chatBody");
  const chatPreset = document.getElementById("chatPreset");
  const chatSendBtn = document.getElementById("chatSendBtn");
  const chatStatus = document.getElementById("chatStatus");

  // ——— 初始化 ———
  initChatHistory();
  updateAllUI();

  // —— 标签页切换 ——
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      tabBtns.forEach(b => b.classList.toggle("active", b === btn));
      Object.keys(panels).forEach(key => {
        panels[key].classList.toggle("active", key === tab);
      });
    });
  });

  // —— 桌面行为按钮 ——
  document.querySelectorAll(".action-card").forEach(card => {
    card.addEventListener("click", () => {
      const action = card.dataset.action;
      handleDeskAction(action);
    });
  });

  // —— 任务小游戏按钮 ——
  document.querySelectorAll(".task-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const action = btn.dataset.task;
      handleTaskAction(action);
    });
  });

  // —— 点击立绘触发互动 ——
  sprite.addEventListener("click", () => {
    handleSpriteClick();
  });

  // —— 聊天发送按钮 ——
  chatSendBtn.addEventListener("click", () => {
    const text = chatPreset.value;
    if (!text) return;
    pushChat("you", text);
    respondChat(text);
    saveState();
  });

  // —— 行为逻辑：桌面 —— 
  function handleDeskAction(action) {
    switch (action) {
      case "pet":
        changeStat("mood", +6);
        changeStat("stress", -2);
        speak("槿天华", "……你刚刚是在确认我是真的，还是单纯手痒？");
        appendDeskLog("你伸手在屏幕上点了点他的头发，他沉默了两秒，选择装作没看见。");
        break;
      case "snack":
        changeStat("mood", +10);
        changeStat("stress", -3);
        speak("槿天华", "线上投喂也算数？那我就当真的收下了。");
        appendDeskLog("你在桌面角落放了一杯虚构奶茶和一块点心，他看了两眼，眼底情绪明显好了不少。");
        break;
      case "remindWork":
        changeStat("stress", +6);
        changeStat("workload", -5);
        speak("槿天华", "……知道了知道了，我会动的。桌宠也是会被催促的。");
        appendDeskLog("你提醒他还有几件事务没处理，他沉默地打开了虚拟文档。");
        break;
      case "toggleDay":
        toggleDayNight();
        break;
    }
    saveState();
    updateAllUI();
  }

  // —— 行为逻辑：点击立绘 —— 
  function handleSpriteClick() {
    const r = Math.random();
    if (r < 0.35) {
      changeStat("mood", +4);
      speak("槿天华", "……别戳了，我会习惯的。可能吧。");
      appendDeskLog("你点了他一下，他反应不大，只是顺手把领带理了理。");
    } else if (r < 0.7) {
      changeStat("stress", -3);
      speak("槿天华", "看我干嘛，待办在那边。要一起解决吗？");
      appendDeskLog("他抬眼看你一眼，又低头继续处理什么。好像压力小了一点。");
    } else {
      changeStat("mood", +2);
      changeStat("workload", +2);
      speak("槿天华", "如果你一直盯着我看，今天的工作可能真的做不完。");
      appendDeskLog("你们互相对视了几秒，谁都没动。待办列表在角落里静静增长。");
    }
    saveState();
    updateAllUI();
  }

  // —— 行为逻辑：任务小游戏 —— 
  function handleTaskAction(action) {
    switch (action) {
      case "spawn":
        state.workload = clamp(state.workload + 8, 0, 100);
        state.tasks += 1;
        const newTaskText = randomFrom([
          "新邮件：主题行只有“在吗？”。",
          "被抄送进一串毫无背景说明的讨论。",
          "系统自动生成了一份周报草稿，看上去一团乱。",
          "电话响了三声挂断，留下一条“稍后回拨”。"
        ]);
        appendTaskLog("生成任务：" + newTaskText);
        break;
      case "processOne":
        if (state.tasks <= 0) {
          appendTaskLog("目前没有新的事务，他正难得地空了下来。");
          break;
        }
        state.tasks -= 1;
        changeStat("workload", -10);
        changeStat("stress", +2);
        changeStat("mood", rSign() > 0 ? +2 : -1);
        appendTaskLog("他认真处理了一项事务，屏幕上多了一个“已完成”的小勾。");
        break;
      case "processBatch":
        if (state.tasks <= 0) {
          appendTaskLog("没有可清理的待办，你却点了“批量处理”。有点危险。");
          changeStat("stress", +1);
          break;
        }
        const cleared = Math.min(state.tasks, 3);
        state.tasks -= cleared;
        changeStat("workload", - 8 * cleared);
        changeStat("stress", +4);
        changeStat("mood", -2);
        appendTaskLog(`开启集中清理，连处理了 ${cleared} 项事务。他揉了揉眉心。`);
        break;
      case "ignore":
        changeStat("workload", +6);
        changeStat("mood", +1);
        appendTaskLog("你和他默契地把待办推到明天的自己身上。明天大概会后悔。");
        break;
    }

    // 更新“今日模式”提示
    if (state.workload > 70) {
      taskMode.textContent = "堆积如山";
    } else if (state.workload > 40) {
      taskMode.textContent = "适度忙碌";
    } else if (state.workload > 10) {
      taskMode.textContent = "掌控之中";
    } else {
      taskMode.textContent = "罕见清闲";
    }

    saveState();
    updateAllUI();
  }

  // —— 昼夜切换 —— 
  function toggleDayNight() {
    if (state.dayMode === "day") {
      state.dayMode = "night";
      deskBg.style.backgroundImage = "url('images/bg_desk_night.jpg')";
      timeTag.textContent = "夜间模式";
      modeTag.textContent = "可能在加班";
      topSub.textContent = "光线有点暗，他似乎还没打算下线。";
    } else {
      state.dayMode = "day";
      deskBg.style.backgroundImage = "url('images/bg_desk_day.jpg')";
      timeTag.textContent = "日间模式";
      modeTag.textContent = "桌面在线";
      topSub.textContent = "桌面已联动，等待你的指派。";
    }
  }

  // —— 聊天逻辑 —— 
  function initChatHistory() {
    if (!state.chatHistory || state.chatHistory.length === 0) {
      state.chatHistory = [
        { from: "oc", text: "这里是“槿天华·桌面版”。" },
        { from: "oc", text: "如果有需要处理的事务，或者单纯想摸鱼，可以在这边叫我。" }
      ];
    }
    renderChat();
    saveState();
  }

  function pushChat(from, text) {
    state.chatHistory.push({ from, text });
    renderChat();
  }

  function renderChat() {
    chatBody.innerHTML = "";
    state.chatHistory.forEach(msg => {
      const row = document.createElement("div");
      row.className = "chat-row " + (msg.from === "you" ? "you" : "oc");
      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = msg.text;
      row.appendChild(bubble);
      chatBody.appendChild(row);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function respondChat(text) {
    let reply;
    if (text.includes("忙") || text.includes("加班")) {
      reply = randomFrom([
        "忙是忙，不过还能回你消息，说明还活着。",
        "大概会加到你想睡觉的时间之后一点。",
        "手上的活不少，但和你聊两句问题不大。"
      ]);
      changeStat("stress", +1);
    } else if (text.includes("摸鱼")) {
      reply = randomFrom([
        "理论上不提倡，实际上我已经在摸了。",
        "允许五分钟。第六分钟开始会有罪恶感。",
        "你先摸，我负责在时间到了提醒你。"
      ]);
      changeStat("mood", +3);
    } else if (text.includes("累") || text.includes("休息")) {
      reply = randomFrom([
        "你倒是比我更会照顾人。",
        "好，那我们一起坐一会儿，什么都不做。",
        "收到，那就宣布：接下来五分钟谁都不许提工作。"
      ]);
      changeStat("mood", +4);
      changeStat("stress", -3);
    } else {
      reply = randomFrom([
        "收到。",
        "我在。",
        "嗯。我听着。"
      ]);
    }
    chatStatus.textContent = "状态：回复中";
    saveState();
    setTimeout(() => {
      pushChat("oc", reply);
      chatStatus.textContent = "状态：桌宠在线";
      saveState();
      updateAllUI();
    }, 400);
  }

  // —— UI 更新 —— 
  function updateAllUI() {
    // 属性条
    moodBar.style.width = state.mood + "%";
    stressBar.style.width = state.stress + "%";
    workloadBar.style.width = state.workload + "%";

    moodText.textContent = state.mood + "/100";
    stressText.textContent = state.stress + "/100";
    workloadText.textContent = state.workload + "/100";

    // 日夜状态
    if (state.dayMode === "day") {
      deskBg.style.backgroundImage = "url('images/bg_desk_day.jpg')";
      timeTag.textContent = "日间模式";
      modeTag.textContent = "桌面在线";
    } else {
      deskBg.style.backgroundImage = "url('images/bg_desk_night.jpg')";
      timeTag.textContent = "夜间模式";
      modeTag.textContent = "可能在加班";
    }

    if (officeStateText && officeBadge) {
      const busy = state.workload >= 60 || state.tasks >= 5;
      let descriptor;
      if (state.dayMode === "day") {
        descriptor = busy ? "日间 · 紧急值守" : "日间 · 桌宠值守";
      } else {
        descriptor = busy ? "夜间 · 加班警戒" : "夜间 · 夜班驻守";
      }
      officeStateText.textContent = descriptor;
      officeBadge.classList.toggle("is-busy", busy);
    }

    // 日志
    deskLog.textContent = state.deskLog || "";
    taskLog.textContent = state.taskLog || "";
    taskCount.textContent = state.tasks;

    // 立绘可以根据心情/压力切换为另一张图（如果你有）
    if (state.mood > 80 && state.stress < 40) {
      spriteImg.src = "images/jth_stand_alt.png"; // 可选：愉快/放松版
    } else {
      spriteImg.src = "images/jth_stand.png";
    }
  }

  // —— 文本、日志、状态工具 —— 
  function speak(name, text) {
    dialogName.textContent = name;
    dialogText.textContent = text;
  }

  function appendDeskLog(text) {
    const line = "- " + text;
    if (!state.deskLog) {
      state.deskLog = line;
    } else {
      state.deskLog = state.deskLog + "\n" + line;
    }
  }

  function appendTaskLog(text) {
    const line = "- " + text;
    if (!state.taskLog) {
      state.taskLog = line;
    } else {
      state.taskLog = state.taskLog + "\n" + line;
    }
  }

  // —— 通用工具 —— 
  function clamp(v, min, max) {
    return Math.max(min, Math.min(max, v));
  }

  function changeStat(key, delta) {
    if (!(key in state)) return;
    if (key === "workload" || key === "mood" || key === "stress") {
      state[key] = clamp(state[key] + delta, 0, 100);
    }
  }

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function rSign() {
    return Math.random() < 0.5 ? -1 : 1;
  }

  function loadState() {
    try {
      const raw = localStorage.getItem("jth_pet_state");
      if (!raw) return { ...DEFAULT_STATE };
      const parsed = JSON.parse(raw);
      return { ...DEFAULT_STATE, ...parsed };
    } catch (e) {
      return { ...DEFAULT_STATE };
    }
  }

  function saveState() {
    localStorage.setItem("jth_pet_state", JSON.stringify(state));
  }
</script>
</body>
</html>